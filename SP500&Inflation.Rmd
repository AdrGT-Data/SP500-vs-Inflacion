---
title: "S&P 500 vs Inflación (CPI) — Análisis mensual"
author: "Adrián Gutiérrez"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
---

# Introducción

ES: En este código compararemos la evolución del sp&500 con la inflación de EEUU. Importante puntuar que el S&P 500 es un **índice de precios de acciones**; el CPI es un **índice de precios al consumidor**. No esperamos que se muevan igual, pero comparar sus variaciones ayuda a interpretar el contexto macro. Los datos estan sacados de Stood(SP500) y de FRED (CPI).

EN: In this code we are going to compare the evolution of SP&500 with the EEUU inflation. It´s important to point the fact that the S&P 500 is a **action price indicator**, and the CPI is a **consumer price indicator** . We won´t expect they evolute as the same way, but compare their variations helps us to interpretate the real context. The dataset have been download from Stood (SP500) and from FRED (CPI).

## Biblioteca de paquetes

Cargamos los paquetes necesarios:

```{r setup, message=FALSE, warning=FALSE}

library(tidyverse)
library(lubridate)
library(janitor)

```

ES: Cargamos los datasets

EN: We load the datasets

```{r}
cpi <- read_csv("CPIAUCSL.csv", show_col_types = FALSE) |>
  rename(date = observation_date, cpi = CPIAUCSL) |>
  mutate(date = as.Date(date))

sp500 <- read_csv("^spx_m.csv", show_col_types = FALSE) |>
  janitor::clean_names() |>
  transmute(date = as.Date(date), sp500 = close)
```

# EDA

ES: En este punto haremos un pequeño análisis exploratorio de los datos donde buscaremos datos faltantes si los hay, visualizaremos los datos, veremos las posibles relaciones que hay entre las dos variables.

EN: In this part we are going to do a little exploratory data analysis. We do this due to we want to find NA or missing observations, visualise the datas, to try to find possible relations between the variables... We will start with a rapid watch of the estructure.

## Limpieza de los datos

ES: Empezaremos con una limpieza de los datasets, buscando datos faltantes, contando las observaciones...

EN: 

```{r}
glimpse(cpi)
```

```{r}
glimpse(sp500)
```

ES: Convertimos los nombres de las columnas a minúsculas, sin espacios ni carácteres especiales para evitar errores al escribir código.

EN:


```{r}
sp500 <- sp500 |> clean_names()
cpi    <- cpi    |> clean_names()
```

ES: Como con `glimpse()` hemos visto que los datos están en días diferentes, agrupamos los datos en vez de en días, en meses.

EN:

```{r}
spx_m <- sp500 |>
  mutate(month = floor_date(as.Date(date), "month")) |>
  group_by(month) |>
  summarise(sp500 = last(sp500), .groups = "drop")

cpi_m <- cpi |>
  mutate(month = floor_date(as.Date(date), "month")) |>
  group_by(month) |>
  summarise(cpi = first(cpi), .groups = "drop")
```

ES: En la primera vista de los datos habíamos visto que el sp500 tiene el triple de observaciones que el CPI. Esta característica puede causarnos problemas en el futuro. Debido a la falta de datos de CPI en varios años.

En Ingeniería de Datos me enseñaron a solo eliminar datos en casos muy concretos y como última opción. Aún así y como este es un pequeño proyecto de análisis de 2 datasets de solo 2 variables de interés, crearemos un nuevo dataset que una estos dos usando la columna `month`como clave. Esto permitirá crear un dataset común, que empiece cuando ambas series tienen datos y acabe cuando ambas terminan.

EN:

```{r}
mezcla <- inner_join(spx_m, cpi_m, by = "month") |>
  arrange(month) #Ordeno las observaciones por orden ascendente

mezcla %>%
  summarise(
    n = n(), # Cuántos meses hay
    start = min(month), # Primera fecha
    end = max(month), # Última fecha
    na_spx = sum(is.na(sp500)), # Vemos los NA (valores faltantes) hay en sp500
    na_cpi = sum(is.na(cpi)) # Vemos los NA (valores faltantes) hay en cpi
  )
```

ES: Gracias a este pequeño paso tenemos un mismo dataset con los datos de interés, sin datos faltantes, con 942 observaciones y con las fechas establecidas a 1 de cada mes.

## Nuevas variables

ES: En este punto crearemos nuevas variables que nos ayudarán en próximos análisis.

EN:

**Retorno mensual del sp500**

ES: El retorno mensual mide el cambio relativo de un mes a otro. Es la métrica básica para ver volatilidad a corto plazo y hacer distribuciones.

EN: 

```{r}
mezcla <- mezcla |>
  arrange(month) |>
  mutate(
    ret_m = (sp500 / lag(sp500) - 1) * 100 # lag() obtiene el valor del mes anterior
  )
```

**Retorno acumulado a 12 meses**











