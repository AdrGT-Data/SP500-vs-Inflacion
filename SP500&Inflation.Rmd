---
title: "S&P 500 vs Inflación (CPI) — Análisis mensual"
author: "Adrián Gutiérrez"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
---
```{r}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)

```

# Introducción

ES: En este análisis compararemos la evolución del **S&P 500** con la **inflación de EE.UU.(CPI)**. Es importante recordar que el S&P 500 es un **índice de precios de acciones**, mientras que el CPI es un **índice de precios al consumidor**. No esperamos que se muevan del mismo modo, pero comparar sus variaciones ayuda a interpretar el contexto macroeconómico. Los datos se han descargado de **Stood**(S&P 500) y de **FRED** (CPI).

EN: In this analysis, we are going to compare the evolution of **SP&500** with the **U.S. inflation (CPI)**. It´s important to note that the S&P 500 is a **stock price index**, whereas the CPI is a **consumer price index** . We do not expect they move as in the same way, but comparing their changes helps us to interpret the macroeconomic context. The datasets were downloaded from **Stood** (SP500) and **FRED** (CPI).

## Biblioteca de paquetes

Cargamos los paquetes necesarios:

```{r setup, message=FALSE, warning=FALSE}

library(tidyverse)
library(lubridate)
library(janitor)
library(scales)

```

ES: Cargamos los datasets

EN: We load the datasets

```{r}
cpi <- read_csv("CPIAUCSL.csv", show_col_types = FALSE) |>
  rename(date = observation_date, cpi = CPIAUCSL) |>
  mutate(date = as.Date(date))

sp500 <- read_csv("^spx_m.csv", show_col_types = FALSE) |>
  janitor::clean_names() |>
  transmute(date = as.Date(date), sp500 = close)
```

# EDA

ES: Realizamos un análisis exploratorio de los datos (EDA) para detectar valores faltantes, entender la estructura y visualizar tendencias. 

Estandarizamos los nombres de las columnas a minúsculas y sin espacios o carácteres especiales para evitar errores al programar.

EN: We do a exploratory data analysis to check for missing values, inspect structure and visualize trends. 

We convert column names to lowercase without spaces or special characters to avoid coding errors.

```{r}
sp500 <- sp500 |> clean_names()
cpi    <- cpi    |> clean_names()
```

ES: Empezamos con una limpieza de los datasets, buscando datos faltantes, contando las observaciones...

EN: We start with a cleaning of the datasets, searching for missing data, counting the observations...

```{r}
glimpse(cpi)
```

```{r}
glimpse(sp500)
```

## Alineación mensual

ES: Dado que las series no comparten el mismo día del mes, agregamos por **mes** (primer día del mes) y tomamos el **último** valor mensual del S&P 500 y el **único/primer** valor del CPI.

EN: Since the series differ in the day within each month, we aggregate to **monthly** (first day of month), using the **last** monthly close for the S&P 500 and the **first/single** value for CPI.

```{r}
spx_m <- sp500 |>
  mutate(month = floor_date(as.Date(date), "month")) |>
  group_by(month) |>
  summarise(sp500 = last(sp500), .groups = "drop")

cpi_m <- cpi |>
  mutate(month = floor_date(as.Date(date), "month")) |>
  group_by(month) |>
  summarise(cpi = first(cpi), .groups = "drop")
```

## Unión y resumen

ES: En anteriores pasos habíamos visto que el sp500 tiene el triple de observaciones que el CPI. Esta cualidad puede causarnos problemas en el futuro. Debido a la falta de datos de CPI en varios años.

En Ingeniería de Datos me han enseñado a solo eliminar datos en casos muy concretos y como última opción. Sin embargo, este es un pequeño proyecto de análisis, por ello crearemos un nuevo dataset que una estos dos usando la columna `month`como clave.

EN: In our first look at the datasets, we observed that the S&P 500 has about three times more observations than the CPI. That characteristic may cause problems in the future.

In Data Engineering teach me only eliminate data if there is not other option. However, this is a little proyect of analysis and that is why we are going to create a new dataset which mix the other using the column `month`as key. 

```{r}
mezcla <- inner_join(spx_m, cpi_m, by = "month") |>
  arrange(month) #Ordeno las observaciones por orden ascendente

mezcla %>%
  summarise(
    n = n(), # Cuántos meses hay
    start = min(month), # Primera fecha
    end = max(month), # Última fecha
    na_spx = sum(is.na(sp500)), # Vemos los NA (valores faltantes) hay en sp500
    na_cpi = sum(is.na(cpi)) # Vemos los NA (valores faltantes) hay en cpi
  )
```

ES: Con esto tenemos un mismo dataset con 942, sin datos faltantes y con un período común: **1947 - 2025/06**.

EN: With that step, we have only one dataset, with 942 observations, without NA and with a common sample: **1947 - 2025/06**.

## Nuevas variables

ES: En este punto crearemos nuevas variables que nos ayudarán en próximos análisis.

EN: At that point we are going to create new variables which will help us in future analisys.

**Retorno mensual del S&P 500**

ES: Mide el cambio relativo de un mes a mes; útil para ver volatilidad a corto plazo y hacer distribuciones.

EN: Measures month-to-month relative change; useful to see the short term volatility and to do distributions.

```{r}
mezcla <- mezcla |>
  arrange(month) |>
  mutate(
    ret_m = (sp500 / lag(sp500) - 1) * 100 # lag() obtiene el valor del mes anterior
  )
```

**Retorno acumulado a 12 meses (Anual)**

ES: Más estable que el mensual; refleja la tendencia anual.

EN: More stable than monthly return; reflects annual trend.

```{r}
mezcla <- mezcla |>
  arrange(month) |>
  mutate(
    ret_12m = (sp500 / lag(sp500, 12) - 1) * 100 
  )
```

**Inflación mensual/anual**

ES: Hacemos lo mismo con la inflación.

EN: We do the same with the CPI.

```{r}
mezcla <- mezcla |>
  arrange(month) |>
  mutate(
    infl_m = (cpi / lag(cpi) - 1) * 100, # Mensual
    
    infl_12m = (cpi/lag(cpi, 12) - 1 ) * 100 # Anual
    
  )
```

**S&P 500 real**

ES: Describe cuanto realmente gana el sp500 después de ajustarlo a la inflación.

EN: Describe how much the S&P 500 gains in real terms after adjusting for inflation.

```{r}
mezcla <- mezcla |>
  arrange(month) |>
  mutate(
    sp500_real = (sp500 / cpi) * 100
  )
```

**Normalización**

ES: Normalizamos ambas series (base 100 en la primera observación) para compararlas en la misma escala.

EN: We normalizate both series (index = 100 at the first observation) to put them on the same scale.

```{r}
mezcla <- mezcla |>
  arrange(month) |>
  mutate(
    sp_norm = sp500 / first(na.omit(sp500)) * 100,
    cpi_norm = cpi / first(na.omit(cpi)) * 100
  )
```

## Visión Estadística

ES: Calculamos estadísticos útiles para posibles inferencias futuras y para poder visualizar la naturaleza de los datos.

EN: We compute useful statisticals to support later inferences in the future and to characterize the data.

```{r}
desc <- mezcla |>
  summarise(
    across(
      .cols = c(sp500, cpi, ret_m, ret_12m, infl_m, infl_12m),
      .fns  = list(
        min    = ~min(.x, na.rm = TRUE),
        p25    = ~quantile(.x, 0.25, na.rm = TRUE), #Primer cuartil
        median = ~median(.x, na.rm = TRUE),
        mean   = ~mean(.x, na.rm = TRUE),
        p75    = ~quantile(.x, 0.75, na.rm = TRUE), # Tercer cuartil
        max    = ~max(.x, na.rm = TRUE)
      ),
      .names = "{.col}_{.fn}"
    )
  )
print(desc)
```

## Visualización

ES: En este punto programaremos gráficos que nos ayuden a ver las relaciones de las variables.

EN: In this point we program different graphics which can help us watching at the relations between variables.

```{r}
mezcla |>
  drop_na(ret_m) |> 
  ggplot(aes(ret_m)) +
  geom_histogram(bins = 40, fill = "skyblue", color = "white") +
  labs(
    title = "Distribución de retornos mensuales del S&P 500",
    x = "% mensual", y = "Frecuencia"
  ) +
  theme_minimal()
```

ES: Muestra volatilidad y asimetría.

EN: Shows volatility and asymmetry.



```{r}
mezcla |> 
  select(month, sp_norm, cpi_norm) |>
  pivot_longer(-month, names_to = "variables", values_to = "norm") |>
  ggplot(aes(month, norm, color = variables)) +
  geom_line(linewidth = 1) +
  labs(
    title = "Evolución normalizada S&P 500 vs CPI",
    x = NULL, y = "Índice"
  ) +
  theme_minimal()
```

ES: Comparamos la evolución de ambas variables normalizadas.

EN: We compare the evolution of both standardized variables.



```{r}
mezcla |>
  drop_na(infl_12m, ret_12m) |>
  select(month, infl_12m, ret_12m) |>
  pivot_longer(-month, names_to = "serie", values_to = "valor") |>
  ggplot(aes(month, valor, color = serie)) +
  geom_hline(yintercept = 0, linetype = "dashed", alpha = 0.5) +
  geom_line(size = 1) +
  scale_y_continuous(labels = label_percent(scale = 1)) +
  labs(
    title = "Inflación interanual vs Retorno S&P 500 a 12m",
    x = NULL, y = "%"
  ) +
  theme_minimal()
```

ES: Permite ver si subidas o bajadas de inflación coinciden con cambios en la rentabilidad.

EN: This graphic makes possible to see whether if the ups and lows of inflation match with the changes in the profitability.



```{r}
mezcla |>
  drop_na(infl_12m, ret_12m) |>
  ggplot(aes(infl_12m, lead(ret_12m, 12))) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  labs(
    title = "Inflación actual vs Retorno S&P 500 en los próximos 12 meses",
    x = "Inflación interanual (%) en t",
    y = "Retorno (%) de t a t+12"
  ) +
  theme_minimal()
```

ES: Un vistazo para ver si hay relación (positiva, negativa o nula) entre inflación y bolsa.

EN: A simple look to watch if there is or not a relationship (positive, negative,non-existent) between inflation and stock market.

# Análisis

## Correlación con rezagos y estabilidad temporal

ES: **ObjetivoS**: 

- Medir **cómo** se relacionan **inflación interanual** y **retorno a 12 meses** del S&P 500. Ver si la inflación "lidera" al retorno futuro.

- Ver si la relación es estable o cambia por régimen/época.

EN: **Objetives**:

- Measuring how annual inflation and annual return are relationated. To watch if the inflation ´lead´ future return.

- To see if the relation is stable or, instead, it changes depends on the regimen/time.

**Correlación**

```{r}
tmp <- mezcla |>
  select(month, infl_12m, ret_12m) |>
  drop_na()


# L > 0 => inflación "lidera" L meses al retorno futuro
shift <- function(x, L) if (L >= 0) dplyr::lead(x,  L) else dplyr::lag(x, -L)

lag_max <- 24
lags_tbl <- tibble(lag = -lag_max:lag_max) |>
  mutate(corr = purrr::map_dbl(lag, ~ cor(tmp$infl_12m, shift(tmp$ret_12m, .x), use = "complete.obs")))

lags_tbl |>
  ggplot(aes(lag, corr)) +
  geom_hline(yintercept = 0, linetype = "dashed", alpha = .6) +
  geom_col(width = .9) +
  labs(title = "Correlación por rezagos",
       subtitle = "L>0: inflación 'lidera'",
       x = "L (meses)", y = "correlación") +
  theme_minimal()

```

ES: Inflación alta hoy se asocia (no se relaciona), en promedio, con **menores retornos** del S&P 500 en los próximos meses (≈ 0–8). El efecto es modesto. **No hay evidencia** de que los retornos predigan la inflación (L muy pequeñas).

EN: Today, high inflation is associated (not relationated), in average, with less returns from S&P 500 in the next months (≈ 0–8). The efect is modest. There is no evidence to say that returns predict inflation (Little L values).

**Estabilidad temporal**

```{r}
M <- cbind(tmp$infl_12m, tmp$ret_12m)
tmp$roll_corr_36m <- zoo::rollapply(
  data = M, width = 36,
  FUN = function(Z) cor(Z[,1], Z[,2]), by.column = FALSE,
  align = "right", fill = NA
)

tmp |>
  ggplot(aes(month, roll_corr_36m)) +
  geom_hline(yintercept = 0, linetype = "dashed", alpha = .6) +
  geom_line(linewidth = 1) +
  labs(title = "Correlación rodante 36 meses",
       subtitle = "Inflación YoY vs retorno del S&P 500 a 12 meses",
       x = NULL, y = "correlación (36m)") +
  theme_minimal()
```


## Regímenes de inflación

ES: Objetivo: Demostrar si los rendimientos cambian materialmente con la inflacion alta/baja

EN:

## Retornos reales

ES: Objetivo: comunicar mejor el poder adquisitivo de la inversión.

EN:

# Conclusiones finales


