---
title: "S&P 500 vs Inflación (CPI) — Análisis mensual"
author: "Adrián Gutiérrez"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
---

# Introducción

ES: En este análisis compararemos la evolución del **S&P 500** con la **inflación de EE.UU.(CPI)**. Es importante recordar que el S&P 500 es un **índice de precios de acciones**, mientras que el CPI es un **índice de precios al consumidor**. No esperamos que se muevan del mismo modo, pero comparar sus variaciones ayuda a interpretar el contexto macroeconómico. Los datos se han descargado de **Stood**(S&P 500) y de **FRED** (CPI).

EN: In this code we are going to compare the evolution of SP&500 with the EEUU inflation. It´s important to point the fact that the S&P 500 is a **action price indicator**, and the CPI is a **consumer price indicator** . We won´t expect they evolute as the same way, but compare their variations helps us to interpretate the real context. The dataset have been download from Stood (SP500) and from FRED (CPI).

## Biblioteca de paquetes

Cargamos los paquetes necesarios:

```{r setup, message=FALSE, warning=FALSE}

library(tidyverse)
library(lubridate)
library(janitor)
library(scales)

```

ES: Cargamos los datasets

EN: We load the datasets

```{r}
cpi <- read_csv("CPIAUCSL.csv", show_col_types = FALSE) |>
  rename(date = observation_date, cpi = CPIAUCSL) |>
  mutate(date = as.Date(date))

sp500 <- read_csv("^spx_m.csv", show_col_types = FALSE) |>
  janitor::clean_names() |>
  transmute(date = as.Date(date), sp500 = close)
```

# EDA

ES: En este punto haremos un pequeño análisis exploratorio de los datos donde buscaremos datos faltantes si los hay, visualizaremos los datos, veremos las posibles relaciones que hay entre las dos variables.

EN: In this part we are going to do a little exploratory data analysis. We do this due to we want to find NA or missing observations, visualise the datas, to try to find possible relations between the variables... We will start with a rapid watch of the estructure.

## Limpieza de los datos

ES: Empezaremos con una limpieza de los datasets, buscando datos faltantes, contando las observaciones...

EN: We are going to start with a cleaning of the datasets, serching for missing datas, counting the observations...

```{r}
glimpse(cpi)
```

```{r}
glimpse(sp500)
```

ES: Convertimos los nombres de las columnas a minúsculas, sin espacios ni carácteres especiales para evitar errores al escribir código.

EN: We turn the names of the columns into small letters, without spaces neither special caracters with the aim of avoid errors in the code.


```{r}
sp500 <- sp500 |> clean_names()
cpi    <- cpi    |> clean_names()
```

ES: Como con `glimpse()` hemos visto que los datos están en días diferentes, agrupamos los datos en vez de en días, en meses.

EN: With the command `glimpse()` we have seen that the dataset have been saved in diferents days of a month, that is why we group in months instead of days.

```{r}
spx_m <- sp500 |>
  mutate(month = floor_date(as.Date(date), "month")) |>
  group_by(month) |>
  summarise(sp500 = last(sp500), .groups = "drop")

cpi_m <- cpi |>
  mutate(month = floor_date(as.Date(date), "month")) |>
  group_by(month) |>
  summarise(cpi = first(cpi), .groups = "drop")
```

ES: En la primera vista de los datos habíamos visto que el sp500 tiene el triple de observaciones que el CPI. Esta cualidad puede causarnos problemas en el futuro. Debido a la falta de datos de CPI en varios años.

En Ingeniería de Datos me enseñaron a solo eliminar datos en casos muy concretos y como última opción. Sin embargo, este es un pequeño proyecto de análisis, por ello crearemos un nuevo dataset que una estos dos usando la columna `month`como clave.

EN: In our first look at the datasets, we observed that the S&P 500 has about three times more observations than the CPI. That characteristic may cause problems in the future.

In Data Engineering teach me only eliminate data if there is not other option. However, this is a little proyect of analysis and that is why we are going to create a new dataset which mix the other using the column `month`as key. 

```{r}
mezcla <- inner_join(spx_m, cpi_m, by = "month") |>
  arrange(month) #Ordeno las observaciones por orden ascendente

mezcla %>%
  summarise(
    n = n(), # Cuántos meses hay
    start = min(month), # Primera fecha
    end = max(month), # Última fecha
    na_spx = sum(is.na(sp500)), # Vemos los NA (valores faltantes) hay en sp500
    na_cpi = sum(is.na(cpi)) # Vemos los NA (valores faltantes) hay en cpi
  )
```

ES: Gracias a este pequeño paso tenemos un mismo dataset con los datos de interés, sin datos faltantes, con 942 observaciones y con las fechas establecidas a 1 de cada mes.

## Nuevas variables

ES: En este punto crearemos nuevas variables que nos ayudarán en próximos análisis.

EN: At that point we are going to create new variables which will help us in future analisys.

**Retorno mensual del sp500**

ES: El retorno mensual mide el cambio relativo de un mes a otro. Es la métrica básica para ver volatilidad a corto plazo y hacer distribuciones.

EN: The monthly return measures the relative change between one month and the next one. Is the basic metric to see the short term volatility and doing distributions.

```{r}
mezcla <- mezcla |>
  arrange(month) |>
  mutate(
    ret_m = (sp500 / lag(sp500) - 1) * 100 # lag() obtiene el valor del mes anterior
  )
```

**Retorno acumulado a 12 meses (Anual)**

ES: El retorno mensual suele ser inestable en muchas inversiones. Usualmente lo que interesa a la hora de analizar inversiones es el retorno anual.

EN: The monthly return usually is unstable in a variety of investments. Many times we use the annual return.

```{r}
mezcla <- mezcla |>
  arrange(month) |>
  mutate(
    ret_12m = (sp500 / lag(sp500, 12) - 1) * 100 
  )
```

**Inflación mensual y anual**

ES: Hacemos lo mismo con la inflación que con el sp500.

EN: We do the same with de CPI.

```{r}
mezcla <- mezcla |>
  arrange(month) |>
  mutate(
    infl_m = (cpi / lag(cpi) - 1) * 100, # Mensual
    
    infl_12m = (cpi/lag(cpi, 12) - 1 ) * 100 # Anual
    
  )
```

**SP500 deflactado por CPI**

ES: Esta variable describe cuanto realmente gana el sp500 sin contar la inflación.

EN: This variable describe how much really win sp500 without inflation.

```{r}
mezcla <- mezcla |>
  arrange(month) |>
  mutate(
    sp500_real = (sp500 / cpi) * 100
  )
```

**Normalizar los valores**

ES: Creamos una variable con las escalas normalizadas para posibles comparaciones futuras.

EN: We need to standar the variables to be able to compare in the future.

```{r}
mezcla <- mezcla |>
  arrange(month) |>
  mutate(
    sp_norm = sp500 / first(na.omit(sp500)) * 100,
    cpi_norm = cpi / first(na.omit(cpi)) * 100
  )
```

## Visión Estadística

ES: Calcularemos estadísticos útiles para posibles inferencias futuras y para poder visualizar la naturaleza de los datos.

EN: We calculate usefull statisticals to possible inferences in the future and to be able to see the data nature.

```{r}
# --- 1) Resumen estadístico ---
desc <- mezcla |>
  summarise(
    across(
      .cols = c(sp500, cpi, ret_m, ret_12m, infl_m, infl_12m),
      .fns  = list(
        min    = ~min(.x, na.rm = TRUE),
        p25    = ~quantile(.x, 0.25, na.rm = TRUE), #Primer cuartil
        median = ~median(.x, na.rm = TRUE),
        mean   = ~mean(.x, na.rm = TRUE),
        p75    = ~quantile(.x, 0.75, na.rm = TRUE), # Tercer cuartil
        max    = ~max(.x, na.rm = TRUE)
      ),
      .names = "{.col}_{.fn}"
    )
  )
print(desc)
```

## Visualización

ES: En este punto programaremos gráficos que nos ayuden a ver las relaciones de las variables.

EN: In this point we program different graphics which can help us watching at the relations between variables.

```{r}
# --- 4) Distribución de retornos mensuales ---
mezcla |>
  ggplot(aes(ret_m)) +
  geom_histogram(bins = 40, fill = "skyblue", color = "white") +
  labs(
    title = "Distribución de retornos mensuales del S&P 500",
    x = "% mensual", y = "Frecuencia"
  ) +
  theme_minimal()
```

ES: Muestra volatilidad y asimetría.

EN: Show volatility and asymmetry.

```{r}
mezcla |> 
  select(month, sp_norm, cpi_norm) |>
  pivot_longer(-month, names_to = "variables", values_to = "norm") |>
  ggplot(aes(month, norm, color = variables)) +
  geom_line(size = 1) +
  labs(
    title = "Evolución normalizada S&P 500 vs CPI",
    x = NULL, y = "Índice"
  ) +
  theme_minimal()
```

ES: En este gráfico simplemente comparamos la evolución de ambas variables normalizadas.

EN: We compare in this graphic the evolution of both standardized variables.

```{r}
# --- 3) Inflación Interanual vs retorno 12m ---
mezcla |>
  select(month, infl_12m, ret_12m) |>
  pivot_longer(-month, names_to = "serie", values_to = "valor") |>
  ggplot(aes(month, valor, color = serie)) +
  geom_hline(yintercept = 0, linetype = "dashed", alpha = 0.5) +
  geom_line(size = 1) +
  scale_y_continuous(labels = label_percent(scale = 1)) +
  labs(
    title = "Inflación interanual vs Retorno S&P 500 a 12m",
    x = NULL, y = "%"
  ) +
  theme_minimal()
```

ES: Permite ver si subidas o bajadas de inflación coinciden con cambios en la rentabilidad.

EN: This graphic make possible watch if the ups and lows of inflation match with the changes in the profitability.

```{r}
# --- 5) Dispersión Inflación vs Retorno futuro ---
mezcla |>
  ggplot(aes(infl_12m, lead(ret_12m, 12))) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  labs(
    title = "Inflación actual vs Retorno S&P 500 en los próximos 12 meses",
    x = "Inflación interanual (%) en t",
    y = "Retorno (%) de t a t+12"
  ) +
  theme_minimal()
```

ES: Un vistazo para ver si hay relación (positiva, negativa o nula) entre inflación y bolsa.

EN: A simple look to watch if there is or not a relationship (positive, negative,non-existent) between inflation and budget.








